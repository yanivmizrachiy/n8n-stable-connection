name: Auto Journal

on:
  # 1) ×”×¨×¦×” ×™×“× ×™×ª â€“ ×××¤×©×¨ ×œ×‘×—×•×¨ ×¤×¢×•×œ×”, ×ª××¨×™×š ×•×ª×•×›×Ÿ
  workflow_dispatch:
    inputs:
      action:
        description: write | append | delete | get
        required: true
        default: write
      date:
        description: 'YYYY-MM-DD or "today"'
        required: false
        default: today
      text:
        description: 'Content to write/append (ignored for delete/get)'
        required: false
        default: ""
  # 2) ×¤×§×•×“×•×ª ×˜×‘×¢×™×•×ª ×“×¨×š ×ª×’×•×‘×” ×œ-Issue (×œ××©×œ "Journal Control")
  issue_comment:
    types: [created]

permissions:
  contents: write      # commit & push
  issues: write        # ×œ×›×ª×•×‘ ×ª×’×•×‘×” ×—×–×¨×” ×œ××™×©×™×• (×× ×¦×¨×™×š)

jobs:
  auto-journal:
    runs-on: ubuntu-latest
    env:
      TZ: "Asia/Jerusalem"  # ×©×¢×•×Ÿ ×™×©×¨××œ ×œ×›×œ ×”-job

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Derive parameters (action/date/text) from trigger
        id: derive
        shell: bash
        run: |
          set -euo pipefail

          EVENT_NAME="${{ github.event_name }}"
          ACTION=""
          DATE_IN=""
          TEXT=""

          if [[ "$EVENT_NAME" == "workflow_dispatch" ]]; then
            ACTION="${{ github.event.inputs.action }}"
            DATE_IN="${{ github.event.inputs.date }}"
            TEXT="${{ github.event.inputs.text }}"
          else
            # issue_comment
            PAYLOAD='${{ toJson(github.event) }}'
            BODY="$(printf '%s' "$PAYLOAD" | jq -r '.comment.body')"

            # ×‘×¨×™×¨×ª ××—×“×œ
            ACTION="write"
            TEXT="$BODY"

            # ×–×™×”×•×™ ×¤×¢×•×œ×•×ª ×˜×‘×¢×™ ×‘×¢×‘×¨×™×ª/×× ×’×œ×™×ª
            shopt -s nocasematch
            if [[ "$BODY" =~ ××—×§[[:space:]]+×™×•××Ÿ|delete[[:space:]]+journal ]]; then
              ACTION="delete"
            elif [[ "$BODY" =~ ×©×œ×•×£[[:space:]]+×™×•××Ÿ|get[[:space:]]+journal ]]; then
              ACTION="get"
            elif [[ "$BODY" =~ ×”×•×¡×£[[:space:]]+×œ×™×•××Ÿ|append[[:space:]]+journal ]]; then
              ACTION="append"
            elif [[ "$BODY" =~ ×›×ª×•×‘[[:space:]]+×‘×™×•××Ÿ|write[[:space:]]+journal ]]; then
              ACTION="write"
            fi
            shopt -u nocasematch

            # ×—×™×¤×•×© ×ª××¨×™×š ×‘×¤×•×¨××˜ YYYY-MM-DD ×‘×˜×§×¡×˜; ×× ××™×Ÿ â€“ today
            if DATE_CANDIDATE="$(grep -Eo '[0-9]{4}-[0-9]{2}-[0-9]{2}' <<<"$BODY" | head -n1)"; then
              DATE_IN="$DATE_CANDIDATE"
            else
              DATE_IN="today"
            fi
          fi

          # × ×¨××•×œ ×ª××¨×™×š
          if [[ "$DATE_IN" == "today" || -z "$DATE_IN" ]]; then
            DATE_STR="$(date +%F)"                       # YYYY-MM-DD ×œ×¤×™ TZ=Asia/Jerusalem
          else
            # ××™××•×ª ×‘×¡×™×¡×™ ×œ×¤×•×¨××˜; ×× ×œ× ×ª×§×™×Ÿ â€“ × ×•×¤×œ×™× ×œ-today
            if [[ "$DATE_IN" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              DATE_STR="$DATE_IN"
            else
              DATE_STR="$(date +%F)"
            fi
          fi

          FILE="context/journal-${DATE_STR}.md"

          echo "action=$ACTION"   >> "$GITHUB_OUTPUT"
          echo "date=$DATE_STR"   >> "$GITHUB_OUTPUT"
          echo "text<<__TXT__"    >> "$GITHUB_OUTPUT"
          printf '%s' "$TEXT"     >> "$GITHUB_OUTPUT"
          echo "__TXT__"          >> "$GITHUB_OUTPUT"
          echo "file=$FILE"       >> "$GITHUB_OUTPUT"

      - name: Ensure context folder
        run: mkdir -p context

      - name: Apply action
        id: apply
        shell: bash
        run: |
          set -euo pipefail
          ACTION='${{ steps.derive.outputs.action }}'
          DATE='${{ steps.derive.outputs.date }}'
          FILE='${{ steps.derive.outputs.file }}'
          TEXT='${{ steps.derive.outputs.text }}'
          TS="$(date '+%H:%M')"

          changed="false"

          if [[ "$ACTION" == "delete" ]]; then
            if [[ -f "$FILE" ]]; then
              rm -f "$FILE"
              changed="true"
              echo "Deleted $FILE"
            else
              echo "No journal for $DATE to delete."
            fi

          elif [[ "$ACTION" == "get" ]]; then
            if [[ -f "$FILE" ]]; then
              echo "### Journal for $DATE" >> "$GITHUB_STEP_SUMMARY"
              echo '' >> "$GITHUB_STEP_SUMMARY"
              echo '```markdown' >> "$GITHUB_STEP_SUMMARY"
              cat "$FILE" >> "$GITHUB_STEP_SUMMARY"
              echo '```' >> "$GITHUB_STEP_SUMMARY"
            else
              echo "No journal for $DATE." >> "$GITHUB_STEP_SUMMARY"
            fi

          elif [[ "$ACTION" == "append" ]]; then
            # ×× ×”×§×•×‘×¥ ×œ× ×§×™×™× â€“ × ×™×¦×•×¨ ×›×•×ª×¨×ª ×‘×¡×™×¡×™×ª
            if [[ ! -f "$FILE" ]]; then
              cat > "$FILE" <<EOF
# ğŸ—“ï¸ ×™×•××Ÿ ×¤×¨×•×™×§×˜ â€” $DATE

## ×¤×¨×˜×™× ×›×œ×œ×™×™×
- ×× ×”×œ: ×™× ×™×‘ ××–×¨×—×™
- ×§×•×‘×¥: \`$FILE\`

## ×¢×“×›×•× ×™× ×™×•××™×™×
EOF
            fi

            {
              echo ""
              echo "### â±ï¸ $TS"
              echo ""
              if [[ -n "$TEXT" ]]; then
                printf "%s\n" "$TEXT"
              else
                echo "_(append â€“ no explicit text)_"
              fi
            } >> "$FILE"
            changed="true"
            echo "Appended to $FILE"

          else
            # write (overwrite): ×ª×‘× ×™×ª ××œ××” ×—×“×©×”
            cat > "$FILE" <<EOF
# ğŸ—“ï¸ ×™×•××Ÿ ×¤×¨×•×™×§×˜ â€” $DATE

## ×¤×¨×˜×™× ×›×œ×œ×™×™×
- ×× ×”×œ: ×™× ×™×‘ ××–×¨×—×™
- ×§×•×‘×¥: \`$FILE\`

## ×¢×“×›×•× ×™× ×™×•××™×™×
### â±ï¸ $TS
$( [[ -n "$TEXT" ]] && printf "%s\n" "$TEXT" || echo "_(entry created)_" )

## ××“×“×™× (××•×¤×¦×™×•× ×œ×™)
- ×”×ª×§×“××•×ª ×›×•×œ×œ×ª: 0%

## ××©×™××•×ª ×”×‘××•×ª
- [ ] â€¦
EOF
            changed="true"
            echo "Wrote $FILE"
          fi

          echo "changed=$changed" >> "$GITHUB_OUTPUT"

      - name: Commit & push (if changed)
        if: steps.apply.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add context/ || true
          git commit -m "journal: ${{ steps.derive.outputs.action }} ${{
            steps.derive.outputs.date }}" || { echo "Nothing to commit."; exit 0; }
          git push

      - name: Reply on issue (optional nice UX)
        if: github.event_name == 'issue_comment'
        shell: bash
        run: |
          set -euo pipefail
          NUM='${{ github.event.issue.number }}'
          ACTION='${{ steps.derive.outputs.action }}'
          DATE='${{ steps.derive.outputs.date }}'
          FILE='${{ steps.derive.outputs.file }}'

          MSG=""
          case "$ACTION" in
            delete) MSG="× ××—×§ ×”×™×•××Ÿ ×©×œ $DATE (×× ×”×™×” ×§×™×™×)." ;;
            get)    MSG="×”×¦×’×ª×™ ××ª ×™×•××Ÿ $DATE ×‘-Actions summary." ;;
            append) MSG="×”×•×¡×¤×ª×™ ×¨×©×•××” ×œ×™×•××Ÿ ×©×œ $DATE." ;;
            write)  MSG="× ×•×¦×¨/× ×›×ª×‘ ××—×“×© ×™×•××Ÿ ×©×œ $DATE." ;;
          esac

          gh api repos/${{ github.repository }}/issues/$NUM/comments \
            -f body="$MSG (×§×•×‘×¥: \`$FILE\`)"

