name: 00 Repo Bootstrap (One-Time)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  seed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Create folders
        run: |
          mkdir -p .github/ISSUE_TEMPLATE
          mkdir -p .github/workflows
          mkdir -p journals
          mkdir -p data-hub/n8n
          mkdir -p data-hub/status

      # -------- Issue Templates --------
      - name: issue template - journal (append to today)
        run: |
          cat > .github/ISSUE_TEMPLATE/journal.md <<'EOF'
          ---
          name: "✍️ כתוב ביומן"
          about: מוסיף טקסט ליומן של היום (נוצר אוטומטית אם לא קיים)
          title: "כתוב ביומן"
          labels: ["journal-write"]
          body:
            - type: textarea
              id: content
              attributes:
                label: תוכן להוספה ביומן
                description: כתוב כאן את מה שתרצה שיופיע ביומן של היום
                placeholder: טקסט חופשי...
              validations:
                required: true
          EOF

      - name: issue template - delete (clear today)
        run: |
          cat > .github/ISSUE_TEMPLATE/journal_delete.md <<'EOF'
          ---
          name: "🗑️ מחק יומן"
          about: מוחק את תוכן היומן של היום (משאיר כותרת ותאריך)
          title: "מחק יומן"
          labels: ["journal-delete"]
          body:
            - type: input
              id: date
              attributes:
                label: תאריך למחיקה (לא חובה)
                description: ברירת מחדל - היום (YYYY-MM-DD)
                placeholder: YYYY-MM-DD
              validations:
                required: false
          EOF

      # -------- Reusable time step --------
      - name: Write helper script for timestamps
        run: |
          cat > .github/workflows/_ts.sh <<'EOF'
          set -euo pipefail
          : "${TZ:=UTC}"
          today="$(date +%F)"
          month="$(date +%Y-%m)"
          echo "today=$today"   >> "$GITHUB_OUTPUT"
          echo "month=$month"   >> "$GITHUB_OUTPUT"
          EOF

      # -------- Workflow: write to journal --------
      - name: workflow - journal write
        run: |
          cat > .github/workflows/journal_write.yml <<'EOF'
          name: 02 Daily Journal (Write/Append)

          on:
            issues:
              types: [opened, edited]
            workflow_dispatch:

          permissions:
            contents: write

          jobs:
            append:
              if: >
                github.event_name == 'workflow_dispatch' ||
                (github.event_name == 'issues' &&
                 (contains(github.event.issue.title, 'כתוב ביומן') || contains(join(github.event.issue.labels.*.name, ','), 'journal-write')))
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                  with: { persist-credentials: true }
                - name: TZ
                  run: echo "TZ=Asia/Jerusalem" >> $GITHUB_ENV
                - name: Today
                  id: ts
                  run: bash .github/workflows/_ts.sh
                - name: Extract body
                  id: body
                  run: |
                    set -euo pipefail
                    if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                      printf "%s" "${{ github.event.inputs.content || '' }}" > body.txt || true
                    else
                      jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH" > body.txt
                    fi
                    echo "len=$(wc -c < body.txt)" >> $GITHUB_OUTPUT
                - name: Ensure header + append
                  run: |
                    set -euo pipefail
                    f="journals/${{ steps.ts.outputs.today }}.md"
                    if [ ! -s "$f" ]; then
                      echo -e "# יומן — ${{ steps.ts.outputs.today }}\n" > "$f"
                    fi
                    echo "" >> "$f"
                    echo "## עדכון — $(date -Iseconds)" >> "$f"
                    echo "" >> "$f"
                    cat body.txt >> "$f"
                    echo "" >> "$f"
                - name: Commit
                  run: |
                    git config user.name "github-actions"
                    git config user.email "actions@users.noreply.github.com"
                    git add journals/
                    git commit -m "journal: append for ${{ steps.ts.outputs.today }}" || echo "no changes"
                    git push
          EOF

      # -------- Workflow: delete journal (today / date) --------
      - name: workflow - journal delete
        run: |
          cat > .github/workflows/journal_delete.yml <<'EOF'
          name: 03 Journal Delete (Today/Date)

          on:
            issues:
              types: [opened, edited]
            workflow_dispatch:
              inputs:
                date:
                  description: YYYY-MM-DD (optional; default today)
                  required: false

          permissions:
            contents: write

          jobs:
            wipe:
              if: >
                github.event_name == 'workflow_dispatch' ||
                (github.event_name == 'issues' &&
                 (contains(github.event.issue.title, 'מחק יומן') || contains(join(github.event.issue.labels.*.name, ','), 'journal-delete')))
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                  with: { persist-credentials: true }
                - name: TZ
                  run: echo "TZ=Asia/Jerusalem" >> $GITHUB_ENV
                - name: Today
                  id: ts
                  run: bash .github/workflows/_ts.sh
                - name: Resolve date
                  id: pick
                  run: |
                    set -euo pipefail
                    want="${{ github.event.inputs.date || '' }}"
                    if [ -z "$want" ] && [ "${{ github.event_name }}" = "issues" ]; then
                      want="$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH" | grep -Eo '^[0-9]{4}-[0-9]{2}-[0-9]{2}$' | head -n1 || true)"
                    fi
                    [ -n "$want" ] || want="${{ steps.ts.outputs.today }}"
                    echo "date=$want" >> "$GITHUB_OUTPUT"
                - name: Wipe file (keep header)
                  run: |
                    set -euo pipefail
                    f="journals/${{ steps.pick.outputs.date }}.md"
                    if [ -f "$f" ]; then
                      { echo "# יומן — ${{ steps.pick.outputs.date }}"; echo; } > "$f"
                    else
                      { echo "# יומן — ${{ steps.pick.outputs.date }}"; echo; } > "$f"
                    fi
                - name: Commit
                  run: |
                    git config user.name "github-actions"
                    git config user.email "actions@users.noreply.github.com"
                    git add journals/
                    git commit -m "journal: wiped ${{ steps.pick.outputs.date }}" || echo "no changes"
                    git push
          EOF

      # -------- Health & Heartbeat --------
      - name: workflow - health check (manual/schedule)
        run: |
          cat > .github/workflows/health.yml <<'EOF'
          name: 10 Health Check (n8n)

          on:
            workflow_dispatch:
            schedule:
              - cron: "17 */2 * * *"   # כל שעתיים + 17 דקות

          permissions:
            contents: write

          jobs:
            ping:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Check vars
                  run: |
                    : "${N8N_HEALTH_URL:?Define repo variable N8N_HEALTH_URL}"
                - name: Curl health
                  id: c
                  run: |
                    set -euo pipefail
                    out="$(curl -fsS --max-time 10 "$N8N_HEALTH_URL" || true)"
                    echo "$out" > health.json
                    echo "raw=$(jq -c . health.json 2>/dev/null || echo null)" >> "$GITHUB_OUTPUT"
                - name: Persist
                  run: |
                    ts="$(date -Iseconds)"
                    mkdir -p data-hub/status
                    jq -n --arg ts "$ts" --argjson h '${{ steps.c.outputs.raw }}' \
                      '{ts:$ts, health:$h}' > data-hub/status/check_latest.json
                    git config user.name "github-actions"
                    git config user.email "actions@users.noreply.github.com"
                    git add data-hub/status/check_latest.json
                    git commit -m "health: update $ts" || echo "no changes"
                    git push
          EOF

      - name: workflow - heartbeat (every 5m)
        run: |
          cat > .github/workflows/heartbeat.yml <<'EOF'
          name: 11 Heartbeat (→ n8n webhook)

          on:
            schedule:
              - cron: "*/5 * * * *"
            workflow_dispatch:

          permissions:
            contents: read

          jobs:
            beat:
              runs-on: ubuntu-latest
              steps:
                - name: Check vars
                  run: |
                    : "${N8N_WEBHOOK_URL:?Define repo variable N8N_WEBHOOK_URL}"
                - name: Post
                  env:
                    BRIDGE_KEY: ${{ secrets.BRIDGE_KEY }}
                  run: |
                    set -euo pipefail
                    ts="$(date -Iseconds)"
                    curl -fsS -X POST "$N8N_WEBHOOK_URL" \
                      -H "Content-Type: application/json" \
                      -H "X-AI-Bridge-Key: ${BRIDGE_KEY:-missing}" \
                      --data "{\"type\":\"heartbeat\",\"ts\":\"$ts\",\"repo\":\"${GITHUB_REPOSITORY}\"}" \
                      | sed -n '1,160p'
          EOF

      # -------- Monthly rollup (optional) --------
      - name: workflow - monthly rollup
        run: |
          cat > .github/workflows/monthly_rollup.yml <<'EOF'
          name: 20 Monthly Rollup

          on:
            schedule:
              - cron: "32 2 1 * *"
            workflow_dispatch:

          permissions:
            contents: write

          jobs:
            rollup:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: TZ
                  run: echo "TZ=Asia/Jerusalem" >> $GITHUB_ENV
                - name: Month
                  id: ts
                  run: bash .github/workflows/_ts.sh
                - name: Build month summary
                  run: |
                    set -euo pipefail
                    m="${{ steps.ts.outputs.month }}"
                    out="journals/${m}-summary.md"
                    echo "# סיכום חודשי — $m" > "$out"
                    echo >> "$out"
                    for f in journals/${m}-*.md journals/${m}-*.MD 2>/dev/null; do
                      [ -f "$f" ] || continue
                      echo "## $(basename "$f")" >> "$out"
                      echo >> "$out"
                      sed '1,1d' "$f" >> "$out" || true
                      echo >> "$out"
                    done
                    git config user.name "github-actions"
                    git config user.email "actions@users.noreply.github.com"
                    git add "$out"
                    git commit -m "monthly rollup: $m" || echo "no changes"
                    git push
          EOF

      - name: .gitkeep files
        run: |
          echo > journals/.gitkeep
          echo > data-hub/n8n/.gitkeep

      - name: Commit all seeded files
        run: |
          git config user.name "github-actions"
          git config user.email "actions@users.noreply.github.com"
          git add .
          git commit -m "bootstrap: seed issue templates & workflows" || echo "no changes"
          git push
